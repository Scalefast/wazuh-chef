driver:
  name: docker
  use_sudo: false
  use_internal_docker_network: true
  remove_images: true
  use_cache: false

provisioner:
  name: chef_zero
  chef_license: accept-no-persist

platforms:
  - name: <%= ENV['PLATFORM'] %>_<%= ENV['RELEASE'] %>_kitchen_chef
    driver_config:
      image: <%= ENV['IMAGE'] %>
      platform: <%= ENV['PLATFORM'] %>
      publish_all: true
      run_command: <%= ENV['RUN_COMMAND'] %>
      privileged: true
      volume:
        - /sys/fs/cgroup:/sys/fs/cgroup:ro
      provision_command:
        - sed -i 's/UsePAM yes/UsePAM no/g' /etc/ssh/sshd_config
        - awk -F= '/^NAME/{print $2}' /etc/os-release | grep -qi 'debian\|ubuntu' && apt-get install -y apt-transport-https gnupg2 ca-certificates|| yum install -y openssl

suites:
  - name: manager
    run_list:
      - recipe[wazuh_manager::default]
      - recipe[filebeat::default]

  - name: agent
    run_list:
      - recipe[wazuh_agent::default]
    attributes:
      ossec:
        address: <%= ENV['MANAGER_IP'] %>